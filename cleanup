#!/usr/bin/env bash
#
# macOS dev-machine cleanup helper
#
# Usage:
#   cleanup                       # normal cleanup
#   cleanup --dry-run             # show what would be done
#   cleanup --confirm             # ask before executing
#   cleanup --deep                # more aggressive Docker cleanup
#   cleanup --report              # show disk usage report after cleanup
#   cleanup --version             # show version
#   cleanup --self-update         # git-based self update (if script lives in a git repo)
#

set -euo pipefail

VERSION="0.2.0"

# Where this script lives
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# ----- Config defaults (can be overridden in ~/.cleanup.conf) -----
CLEANUP_DEFAULT_CONFIRM=${CLEANUP_DEFAULT_CONFIRM:-0}
CLEANUP_DEFAULT_DEEP=${CLEANUP_DEFAULT_DEEP:-0}
CLEANUP_DEFAULT_REPORT=${CLEANUP_DEFAULT_REPORT:-1}
CLEANUP_LOGGING=${CLEANUP_LOGGING:-1}
CLEANUP_LOG_DIR=${CLEANUP_LOG_DIR:-"$HOME/.cleanup/logs"}
CLEANUP_CONFIG_FILE=${CLEANUP_CONFIG_FILE:-"$HOME/.cleanup.conf"}

# ----- Load optional config file -----
if [ -f "$CLEANUP_CONFIG_FILE" ]; then
  # shellcheck source=/dev/null
  . "$CLEANUP_CONFIG_FILE"
fi

usage() {
  cat <<EOF
cleanup $VERSION

Usage: cleanup [options]

Options:
  --dry-run       Show what would be cleaned, but don't delete anything
  --confirm       Ask for confirmation before running
  --deep          Run deeper cleanup (e.g. Docker volumes & images)
  --report        Show a disk usage summary after cleanup
  --version       Print the cleanup version and exit
  --self-update   Update this script from its git remote (if in a git repo)
  -h, --help      Show this help
EOF
}

self_update() {
  if command -v git >/dev/null 2>&1 && [ -d "$SCRIPT_DIR/.git" ]; then
    echo "üîÑ Self-updating cleanup from git remote in: $SCRIPT_DIR"
    (cd "$SCRIPT_DIR" && git pull --rebase) || {
      echo "‚ö†Ô∏è  git pull failed. Check your network/remote."
      return 1
    }
    echo "‚úÖ Update complete."
  else
    echo "‚ö†Ô∏è  Self-update requires this script to be in a git clone."
    echo "    Current directory: $SCRIPT_DIR"
    echo "    Hint: git init && git remote add origin <repo> && git pull"
  fi
}

# ----- Runtime flags (CLI overrides config defaults) -----
DRY_RUN=0
CONFIRM=${CLEANUP_DEFAULT_CONFIRM:-0}
DEEP=${CLEANUP_DEFAULT_DEEP:-0}
REPORT=${CLEANUP_DEFAULT_REPORT:-0}
SELF_UPDATE=0

# ----- Parse args -----
for arg in "$@"; do
  case "$arg" in
    --dry-run) DRY_RUN=1 ;;
    --confirm) CONFIRM=1 ;;
    --deep) DEEP=1 ;;
    --report) REPORT=1 ;;
    --version)
      echo "cleanup $VERSION"
      exit 0
      ;;
    --self-update) SELF_UPDATE=1 ;;
    -h|--help) usage; exit 0 ;;
    *)
      echo "Unknown option: $arg" >&2
      usage
      exit 1
      ;;
  esac
done

# Self-update takes precedence and then exits
if [ "$SELF_UPDATE" -eq 1 ]; then
  self_update
  exit $?
fi

# ----- Optional confirmation -----
if [ "$CONFIRM" -eq 1 ] && [ "$DRY_RUN" -eq 0 ]; then
  echo "About to run cleanup with options:"
  echo "  DRY_RUN = $DRY_RUN"
  echo "  DEEP    = $DEEP"
  echo "  REPORT  = $REPORT"
  read -r -p "Proceed? [y/N] " answer
  case "$answer" in
    [Yy]*) ;;
    *) echo "Aborted."; exit 0 ;;
  esac
fi

# ----- Logging setup -----
TIMESTAMP="$(date +'%Y%m%d-%H%M%S')"
LOG_FILE="$CLEANUP_LOG_DIR/cleanup-$TIMESTAMP.log"

if [ "$DRY_RUN" -eq 0 ] && [ "${CLEANUP_LOGGING:-1}" -eq 1 ]; then
  mkdir -p "$CLEANUP_LOG_DIR"
  # Log everything to file and still display on console
  exec > >(tee -a "$LOG_FILE") 2>&1
  echo "üìÅ Logging to: $LOG_FILE"
fi

run_cmd() {
  if [ "$DRY_RUN" -eq 1 ]; then
    echo "DRY RUN: $*"
  else
    "$@"
  fi
}

delete_path() {
  local target="$1"
  if [ ! -e "$target" ]; then
    return 0
  fi

  if [ "$DRY_RUN" -eq 1 ]; then
    echo "DRY RUN: rm -rf \"$target\""
  else
    rm -rf "$target"
  fi
}

echo "üîç Starting system cleanup (dry-run=$DRY_RUN, deep=$DEEP)..."

# --- Homebrew cleanup ---
if command -v brew >/dev/null 2>&1; then
  echo "üßπ Cleaning Homebrew..."
  run_cmd brew cleanup -s || true
fi

# --- Node / JS tooling caches ---
echo "üßπ Cleaning Node / JS caches..."
if [ -d "$HOME/.npm" ]; then
  run_cmd npm cache clean --force || true
fi
delete_path "$HOME/Library/Caches/pnpm"
delete_path "$HOME/Library/Caches/Yarn"

# --- Python pip cache ---
echo "üêç Cleaning Python pip cache..."
delete_path "$HOME/Library/Caches/pip"

# --- RubyGems cache ---
echo "üíé Cleaning RubyGems cache dirs..."
if [ -d "$HOME/.gem" ]; then
  if [ "$DRY_RUN" -eq 1 ]; then
    echo "DRY RUN: would remove RubyGems cache directories under $HOME/.gem:"
    find "$HOME/.gem" -type d -name cache -print 2>/dev/null || true
  else
    find "$HOME/.gem" -type d -name cache -exec rm -rf {} + 2>/dev/null || true
  fi
fi

# --- VSCode caches ---
echo "üß† Cleaning VSCode caches..."
VSCODE_BASE="$HOME/Library/Application Support/Code"
delete_path "$VSCODE_BASE/Cache"
delete_path "$VSCODE_BASE/CachedData"
delete_path "$VSCODE_BASE/CachedExtensionVSIXs"

# --- Docker prune (safe) ---
if command -v docker >/dev/null 2>&1; then
  echo "üê≥ Cleaning Docker unused resources (safe)..."
  run_cmd docker system prune -f || true

  if [ "$DEEP" -eq 1 ]; then
    echo "üê≥ DEEP: Pruning unused Docker images & volumes..."
    run_cmd docker system prune -af --volumes || true
  fi
fi

# --- ZSH compdump cleanup ---
echo "üßπ Removing old zsh compdump files..."
if [ "$DRY_RUN" -eq 1 ]; then
  echo "DRY RUN: would remove:"
  ls "$HOME"/.zcompdump-* 2>/dev/null || true
else
  rm -f "$HOME"/.zcompdump-* 2>/dev/null || true
fi

# --- JCEF logs (size 0) ---
echo "üßπ Removing empty jcef_*.log files in home..."
shopt -s nullglob || true
for f in "$HOME"/jcef_*.log; do
  if [ -e "$f" ] && [ ! -s "$f" ]; then
    if [ "$DRY_RUN" -eq 1 ]; then
      echo "DRY RUN: rm \"$f\""
    else
      rm -f "$f"
    fi
  fi
done
shopt -u nullglob || true

# --- .DS_Store cleanup ---
echo "üßπ Removing .DS_Store files..."
if [ "$DRY_RUN" -eq 1 ]; then
  echo "DRY RUN: would remove these .DS_Store files:"
  find "$HOME" -name '.DS_Store' -print 2>/dev/null || true
else
  find "$HOME" -name '.DS_Store' -exec rm -f {} + 2>/dev/null || true
fi

echo "‚ú® Cleanup steps finished."

# --- Report disk usage ---
if [ "$REPORT" -eq 1 ]; then
  echo
  echo "üìä Disk usage summary (top-level under \$HOME):"
  du -sh "$HOME" 2>/dev/null || true
  echo
  du -sh "$HOME"/* 2>/dev/null | sort -h || true
fi

echo "‚úÖ Done."
